# cat-github-watcher

**PR monitoring tool for the automated implementation phase by GitHub Copilot**

<p align="left">
  <a href="README.ja.md"><img src="https://img.shields.io/badge/üáØüáµ-Japanese-red.svg" alt="Japanese"></a>
  <a href="README.md"><img src="https://img.shields.io/badge/üá∫üá∏-English-blue.svg" alt="English"></a>
</p>

*This document is mostly AI-generated, generated by submitting an issue to an agent.

## Status
- Currently dogfooding.
- Major bugs have been addressed.
- Frequent breaking changes occur.
- Notes
  - Initially, implementation was attempted with GitHub Actions, but it proved unsuitable for the purpose of PR monitoring, so it was migrated to a Python version.
  - The Python version monitors authenticated GitHub users' owned repositories and performs notifications and actions according to the PR's phase.

## Quick Links
| Item | Link |
|------|--------|
| üìä GitHub Repository | [cat2151/cat-github-watcher](https://github.com/cat2151/cat-github-watcher) |

## Overview

This Python tool monitors the phases of Pull Requests where GitHub Copilot performs automated implementations, executing appropriate notifications and actions at the right time.
It efficiently monitors PRs using the GraphQL API, targeting repositories owned by authenticated GitHub users.

## Features

- **Automated Monitoring of All Repositories**: Automatically monitors PRs in repositories owned by authenticated GitHub users.
- **Leverages GraphQL API**: Achieves fast monitoring through efficient data retrieval.
- **Phase Detection**: Automatically determines the PR's state (phase1: Draft, phase2: Addressing review comments, phase3: Awaiting review, LLM working: Coding agent at work).
- **Dry-run Mode**: By default, it only monitors and does not execute actual actions (posting comments, making PRs ready, sending notifications). It can be safely operated by explicitly enabling execution.
- **Automated Comment Posting**: Automatically posts appropriate comments based on the phase (requires enablement in config file).
- **Automated Draft PR Ready-up**: Automatically changes Draft PRs to a Ready state for addressing review comments in phase2 (requires enablement in config file).
- **Mobile Notifications**: Uses ntfy.sh to notify mobile devices when phase3 (awaiting review) is detected (requires enablement in config file).
- **Issue List Display**: If all PRs are "LLM working", displays the top 10 issues for repositories with no open PRs.

## Architecture

This tool is a Python application modularized according to the Single Responsibility Principle (SRP).

### Directory Structure

```
cat-github-watcher/
‚îú‚îÄ‚îÄ cat-github-watcher.py    # Entry point
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ gh_pr_phase_monitor/
‚îÇ       ‚îú‚îÄ‚îÄ colors.py         # ANSI Color Codes and Coloring
‚îÇ       ‚îú‚îÄ‚îÄ config.py         # Configuration Loading and Parsing
‚îÇ       ‚îú‚îÄ‚îÄ github_client.py  # GitHub API Integration
‚îÇ       ‚îú‚îÄ‚îÄ phase_detector.py # PR Phase Determination Logic
‚îÇ       ‚îú‚îÄ‚îÄ comment_manager.py # Comment Posting and Verification
‚îÇ       ‚îú‚îÄ‚îÄ pr_actions.py     # PR Actions (Ready-up, Browser Launch)
‚îÇ       ‚îî‚îÄ‚îÄ main.py           # Main Execution Loop
‚îî‚îÄ‚îÄ tests/                    # Test files
```

### Phase Detection Logic

The tool determines the following four phases:

1. **phase1 (Draft state)**: When the PR is in Draft state and has review requests.
2. **phase2 (Addressing review comments)**: When `copilot-pull-request-reviewer` has posted review comments and corrections are needed.
3. **phase3 (Awaiting review)**: When `copilot-swe-agent` has completed corrections and the PR is awaiting human review.
4. **LLM working (Coding agent at work)**: When none of the above apply (e.g., Copilot is implementing).

## Usage

### Prerequisites

- Python 3.x is installed.
- GitHub CLI (`gh`) is installed and authenticated.
  ```bash
  gh auth login
  ```

### Setup

1. Clone this repository:
   ```bash
   git clone https://github.com/cat2151/cat-github-watcher.git
   cd cat-github-watcher
   ```

2. Create a configuration file (optional):
   ```bash
   cp config.toml.example config.toml
   ```

3. Edit `config.toml` to configure monitoring interval, execution mode, ntfy.sh notifications, Copilot auto-assignment, and auto-merge (optional):
   ```toml
   # Check interval (e.g., "30s", "1m", "5m", "1h", "1d")
   interval = "1m"
   
   # Execution control flags - Must be specified in [[rulesets]] sections
   # Global flags are no longer supported
   # Use 'repositories = ["all"]' to apply settings to all repositories
   
   # Example ruleset configuration:
   # [[rulesets]]
   # name = "All repositories default - dry-run mode"
   # repositories = ["all"]  # "all" matches all repositories
   # enable_execution_phase1_to_phase2 = false  # Set to true to mark draft PRs as ready
   # enable_execution_phase2_to_phase3 = false  # Set to true to post phase2 comments
   # enable_execution_phase3_send_ntfy = false  # Set to true to send ntfy notifications
   # enable_execution_phase3_to_merge = false   # Set to true to merge phase3 PRs
   
   # ntfy.sh notification settings (optional)
   # Notifications include clickable action buttons to open the PR
   [ntfy]
   enabled = false  # Set to true to enable notifications
   topic = "<„Åì„Åì„Å´ntfy.sh„ÅÆ„Éà„Éî„ÉÉ„ÇØÂêç„ÇíÊõ∏„Åè>"  # Anyone can read/write to it, so use a non-guessable string
   message = "PR is ready for review: {url}"  # Message template
   priority = 4  # Notification priority (1=lowest, 3=default, 4=high, 5=highest)
   
   # Phase3 Auto-Merge Settings (optional)
   # Automatically merges PRs when they reach phase3 (awaiting review)
   # The comment defined below will be posted to the PR before merging
   # After successful merge, the feature branch is automatically deleted
   [phase3_merge]
   enabled = false  # Set to true to enable auto-merge (requires enable_execution_phase3_to_merge = true in rulesets)
   comment = "All checks passed. Merging PR."  # Comment to post before merging
   automated = false  # Set to true to click the merge button via browser automation
   automation_backend = "selenium"  # Automation backend: "selenium" or "playwright"
   wait_seconds = 10  # Wait time in seconds after browser launch and before button click
   browser = "edge"  # Browser to use: Selenium: "edge", "chrome", "firefox" / Playwright: "chromium", "firefox", "webkit"
   headless = false  # Run in headless mode (do not display browser window)
   
   # Auto-assign "good first issue" issues to Copilot (optional)
   # If enabled, opens the issue in a browser and prompts to click "Assign to Copilot" button
   # If automated = true, automatically clicks the button via browser automation (requires Selenium)
   [assign_to_copilot]
   enabled = false  # Set to true to enable auto-assignment feature
   automated = false  # Set to true to enable browser automation (requires: pip install selenium webdriver-manager)
   wait_seconds = 10  # Wait time in seconds after browser launch and before button click
   browser = "edge"  # Browser to use ("edge", "chrome", "firefox")
   ```

4. (Optional) If you plan to use browser automation, install Selenium:
   ```bash
   pip install -r requirements-automation.txt
   ```
   Or
   ```bash
   pip install selenium webdriver-manager
   ```
   
   Additionally, you will need the driver for your chosen browser:
   - **Edge**: Built-in on Windows 10/11 (no additional installation required).
   - **Chrome**: ChromeDriver will be downloaded automatically.
   - **Firefox**: GeckoDriver will be downloaded automatically.
   ```

### Execution

Start the tool to begin monitoring:

```bash
python3 cat-github-watcher.py [config.toml]
```

Or run directly as a Python module:

```bash
python3 -m src.gh_pr_phase_monitor.main [config.toml]
```

### Workflow

1. **Start**: When the tool starts, it begins monitoring repositories owned by the authenticated GitHub user.
2. **PR Detection**: Automatically detects repositories with open PRs.
3. **Phase Determination**: Determines the phase of each PR (phase1/2/3, LLM working).
4. **Action Execution**:
   - **phase1**: Dry-run by default (changes Draft PRs to Ready state if `enable_execution_phase1_to_phase2 = true`).
   - **phase2**: Dry-run by default (posts a comment requesting Copilot to apply changes if `enable_execution_phase2_to_phase3 = true`).
   - **phase3**: Opens the PR page in a browser (also sends ntfy.sh notification if `enable_execution_phase3_send_ntfy = true`, and auto-merges the PR if `enable_execution_phase3_to_merge = true`).
   - **LLM working**: Waits (if all PRs are in this state, displays issues from repositories with no open PRs).
5. **Repeat**: Continues monitoring at the configured interval.

### Dry-run Mode

By default, the tool operates in **Dry-run mode** and does not execute actual actions, allowing for safe operational verification.

- **Phase1 (Draft ‚Üí Ready-up)**: Displays `[DRY-RUN] Would mark PR as ready for review` but does not perform any actual action.
- **Phase2 (Comment Posting)**: Displays `[DRY-RUN] Would post comment for phase2` but does not perform any actual action.
- **Phase3 (ntfy Notification)**: Displays `[DRY-RUN] Would send ntfy notification` but does not perform any actual action.
- **Phase3 (Merge)**: Displays `[DRY-RUN] Would merge PR` but does not perform any actual action.

To enable actual actions, set the following flags to `true` in `config.toml`:
```toml
enable_execution_phase1_to_phase2 = true  # Mark Draft PR as Ready
enable_execution_phase2_to_phase3 = true  # Post Phase2 comments
enable_execution_phase3_send_ntfy = true  # Send ntfy notifications
enable_execution_phase3_to_merge = true   # Merge Phase3 PRs
```

### Stopping

You can stop monitoring with `Ctrl+C`.

## Notes

- GitHub CLI (`gh`) must be installed and authenticated.
- Integration with GitHub Copilot (specifically `copilot-pull-request-reviewer` and `copilot-swe-agent`) is assumed.
- **Only repositories owned by the authenticated user** are monitored. Organization repositories are not included to keep the tool simple and focused (YAGNI principle).
- Be mindful of API rate limits when using the GraphQL API.
- If using ntfy.sh notifications, configure a topic on [ntfy.sh](https://ntfy.sh/) beforehand.

## Testing

The project includes a test suite using pytest:

```bash
pytest tests/
```

## License

MIT License - See the LICENSE file for details.

*The English version of README.md is automatically generated by GitHub Actions using Gemini's translation based on README.ja.md.*

*Big Brother is watching your repositories. Now it‚Äôs the cat.* üê±